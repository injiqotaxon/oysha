import express from "express";
import fetch from "node-fetch";

const app = express();
const PORT = process.env.PORT || 3000;

// API –∫–∞–ª–∏—Ç –≤–∞ –º–∞–Ω–±–∞–ª–∞—Ä
const OPENWEATHER_KEY = "7fd7625b5eb3747e1ec5ee7d10c64fc9";
const CBU_JSON = "https://cbu.uz/oz/arkhiv-kursov-valyut/json/";

// –ê—Å–æ—Å–∏–π —Å–∞“≥–∏—Ñ–∞ (HTML)
app.get("/", (req, res) => {
  res.send(`
<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–û–±-“≥–∞–≤–æ –≤–∞ –í–∞–ª—é—Ç–∞ –∫—É—Ä—Å–ª–∞—Ä–∏</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:#1e293b; --accent:#38bdf8; --text:#fff;
  }
  body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);padding:20px;}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
  h1{margin:0;font-size:28px;}
  .clock{font-size:20px;font-weight:600;}
  .section{background:var(--card);padding:20px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.4);margin-bottom:20px;}
  .title{font-size:22px;font-weight:600;margin-bottom:12px;color:var(--accent);}
  .weather-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
  .city{background:rgba(255,255,255,0.05);padding:12px;border-radius:10px;text-align:center;}
  .city h3{margin:0;font-size:18px;}
  .city .temp{font-size:28px;font-weight:700;margin:6px 0;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  td{padding:8px;font-size:16px;}
  td:last-child{text-align:right;}
  .footer{text-align:center;color:#a1aab8;font-size:13px;margin-top:30px;}
</style>
</head>
<body>
<header>
  <h1>–û–±-“≥–∞–≤–æ</h1>
  <div class="clock" id="clock">--:--:--</div>
</header>

<div class="section">
  <div class="title">–ë–∞—Ä—á–∞ –≤–∏–ª–æ—è—Ç–ª–∞—Ä</div>
  <div class="weather-grid" id="weather"></div>
</div>

<div class="section">
  <div class="title">–ö—É—Ä—Å–ª–∞—Ä</div>
  <table id="rates"></table>
</div>

<div class="footer">
  ¬© 2025 KursWeather. –ú–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä –º–∞–Ω–±–∞–ª–∞—Ä–∏: CBU.uz –≤–∞ OpenWeather.
</div>

<script>
function startClock(){
  function t(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('uz-UZ',{hour12:false});}
  t(); setInterval(t,1000);
}

async function loadWeather(){
  const res = await fetch('/weather');
  const data = await res.json();
  const el = document.getElementById('weather');
  el.innerHTML='';
  data.forEach(c=>{
    const d=document.createElement('div');
    d.className='city';
    d.innerHTML=\`<h3>\${c.name}</h3><div class="temp">\${c.temp}¬∞C</div><div>\${c.desc}</div>\`;
    el.appendChild(d);
  });
}

async function loadRates(){
  const res = await fetch('/rates');
  const data = await res.json();
  const el = document.getElementById('rates');
  el.innerHTML='';
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=\`<td>\${r.Ccy}</td><td>\${Number(r.Rate).toLocaleString()} UZS</td>\`;
    el.appendChild(tr);
  });
}

startClock();
loadWeather();
loadRates();
setInterval(loadWeather, 5*60*1000);
setInterval(loadRates, 2*60*1000);
</script>
</body>
</html>
`);
});

// –û–±-“≥–∞–≤–æ –º–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä–∏
app.get("/weather", async (req, res) => {
  const cities = [
    "Tashkent","Samarkand","Bukhara","Fergana","Namangan",
    "Andijan","Nukus","Urgench","Qarshi","Jizzakh",
    "Navoi","Termez","Kokand","Sirdaryo"
  ];

  try {
    const results = await Promise.all(
      cities.map(async (city) => {
        const url = \`https://api.openweathermap.org/data/2.5/weather?q=\${city}&units=metric&lang=uz&appid=\${OPENWEATHER_KEY}\`;
        const r = await fetch(url);
        const d = await r.json();
        return {
          name: city,
          temp: Math.round(d.main.temp),
          desc: d.weather[0].description
        };
      })
    );
    res.json(results);
  } catch (err) {
    res.status(500).json({error: "Weather API xatosi"});
  }
});

// –í–∞–ª—é—Ç–∞ –º–∞—ä–ª—É–º–æ—Ç–ª–∞—Ä–∏
app.get("/rates", async (req, res) => {
  try {
    const r = await fetch(CBU_JSON);
    const d = await r.json();
    const filtered = d.filter(x => ["USD","EUR","RUB","GBP"].includes(x.Ccy));
    res.json(filtered);
  } catch (err) {
    res.status(500).json({error: "CBU API xatosi"});
  }
});

app.listen(PORT, () => console.log(\`üöÄ –°–µ—Ä–≤–µ—Ä –∏—à–ª–∞—è–ø—Ç–∏: http://localhost:\${PORT}\`));
