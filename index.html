<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fonni olib tashlash (U¬≤-Net)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 800px;
    }
    h1 {
      margin-top: 0;
      color: #1f2937;
    }
    input[type=file] {
      margin: 15px 0;
      padding: 10px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 8px;
    }
    #preview {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîπ Fonni olib tashlash ‚Äî barcha turlarga mos</h1>
    <p>Rasm yuklang, fon avtomatik tarzda olib tash–ª–∞–Ωadi (API talab qilinmaydi).</p>

    <input type="file" id="fileInput" accept="image/*">
    <br>
    <button id="removeBtn">Fon olib tashlash</button>
    <a id="downloadLink" style="display:none;" download="fon_siz.png">‚¨áÔ∏è Yuklab olish</a>

    <img id="preview" alt="Natija">
    <p id="status" style="color:gray; margin-top:10px;"></p>
  </div>

  <!-- ONNX Runtime Web -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

  <script>
    const modelUrl = "https://huggingface.co/onnx-community/u2net/resolve/main/u2net.onnx";
    const fileInput = document.getElementById('fileInput');
    const removeBtn = document.getElementById('removeBtn');
    const preview = document.getElementById('preview');
    const downloadLink = document.getElementById('downloadLink');
    const status = document.getElementById('status');
    let session;

    async function loadModel() {
      status.textContent = "Model yuklanmoqda...";
      session = await ort.InferenceSession.create(modelUrl);
      status.textContent = "Model tayyor ‚úÖ";
    }

    async function processImage(img) {
      // Canvas tayyor–ª–∞–π–º–∏–∑
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const size = 320;
      canvas.width = size;
      canvas.height = size;
      ctx.drawImage(img, 0, 0, size, size);

      // ImageData‚Äô–Ω–∏ tensor–≥–∞ –∞–π–ª–∞–Ω—Ç–∏—Ä–∞–º–∏–∑
      const imageData = ctx.getImageData(0, 0, size, size);
      const input = new Float32Array(1 * 3 * size * size);
      for (let i = 0; i < size * size; i++) {
        input[i] = imageData.data[i * 4] / 255;         // R
        input[i + size * size] = imageData.data[i * 4 + 1] / 255; // G
        input[i + 2 * size * size] = imageData.data[i * 4 + 2] / 255; // B
      }

      const tensor = new ort.Tensor('float32', input, [1, 3, size, size]);
      const result = await session.run({ "input": tensor });
      const output = result[Object.keys(result)[0]].data;

      // Alfa –∫–∞–Ω–∞–ª–∏–Ω–∏ —è—Ä–∞—Ç–∏—à
      const maskCanvas = document.createElement('canvas');
      maskCanvas.width = img.width;
      maskCanvas.height = img.height;
      const mctx = maskCanvas.getContext('2d');
      const maskData = mctx.createImageData(img.width, img.height);
      for (let i = 0; i < output.length; i++) {
        const val = Math.min(255, Math.max(0, output[i] * 255));
        maskData.data[i * 4 + 0] = 255;
        maskData.data[i * 4 + 1] = 255;
        maskData.data[i * 4 + 2] = 255;
        maskData.data[i * 4 + 3] = val;
      }
      mctx.putImageData(maskData, 0, 0);

      // –ê—Å–æ—Å–∏–π —Ç–∞—Å–≤–∏—Ä –±–∏–ª–∞–Ω –±–∏—Ä–ª–∞—à—Ç–∏—Ä–∞–º–∏–∑
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = img.width;
      finalCanvas.height = img.height;
      const fctx = finalCanvas.getContext('2d');
      fctx.drawImage(img, 0, 0, img.width, img.height);
      fctx.globalCompositeOperation = "destination-in";
      fctx.drawImage(maskCanvas, 0, 0);

      // –ù–∞—Ç–∏–∂–∞–Ω–∏ —á–∏“õ–∞—Ä–∞–º–∏–∑
      const blob = await new Promise(res => finalCanvas.toBlob(res, "image/png"));
      const url = URL.createObjectURL(blob);
      preview.src = url;
      preview.style.display = "block";
      downloadLink.href = url;
      downloadLink.style.display = "block";
      status.textContent = "‚úÖ Tayyor!";
    }

    removeBtn.onclick = async () => {
      const file = fileInput.files[0];
      if (!file) return alert("Iltimos, rasm tanlang!");

      const img = new Image();
      img.onload = async () => {
        status.textContent = "Fon olib tash–ª–∞–Ωmoqda...";
        await processImage(img);
      };
      img.src = URL.createObjectURL(file);
    };

    loadModel();
  </script>
</body>
</html>
